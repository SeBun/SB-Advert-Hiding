# SB-Advert-Hiding-Joomla-plugin
**Плагин для автоматического изменения прав доступа к рекламным материалам после истечения срока публикации.**
Работает с материалами, имеющими пользовательские поля advertising (рекламный материал) и hiding (дата скрытия). Создан для облегчения управления рекламными материалами в целях соответствия Федеральному закону 38-ФЗ «О рекламе».

## Для чего это нужно
Согласно 38-ФЗ «О рекламе», любая рекламная информация, доступная неопределённому кругу лиц, подлежит маркировке и отчётности вне зависимости от даты её первоначальной публикации. После истечения этого срока можно удалить или переместить материалы из публичного доступа, чтобы они не считались «распространением рекламы». Альтернативный путь — преобразовать старые рекламные статьи в справочно-информационные материалы, исключив любые элементы продвижения товара, и/или ограничить к ним доступ зарегистрированными пользователями, что юридически избавляет от необходимости маркировки и отчётности и при этом сохраняет SEO-контент.

Каждый рекламный материал подразумевает наличие даты публикации и даты завершения. Однако, если вам не требуется снимать материал с публикации, а оставить его доступным, но скрыть с фронтента, то этот плагин облегчит задачу. Он выполняет только одно действие — в соответствии с заданными настройками меняет права доступа к материалам. Например, можно изменить доступ с Public на Registered, и тогда материалы становятся доступны только зарегистрированным пользователям.

Кроме того, если добавить к полям такие, как ERID и наименование рекламодателя, то можно в шаблоне вывода материала автоматически формировать бейдж "Реклама", как того требует 38-ФЗ.

## Настройки
**Интервал проверки (в секундах)** задает частоту запуска плагина. Например, по умолчанию стоит значение 3600, что означает, что плагин будет запускаться каждый час. 
**Количество материалов за раз** определяет, сколько материалов будет обработано за один раз.
**Категории для применения** — набор категорий, в которых плагин будет искать материалы. Укажите только те, в которых вы публикуете рекламные материалы. Будет правильным также задать эти же категории для пользовательских полей advertising и hiding.
**Группа для публичного доступа** — это та группа, пользователям которой доступны материалы с фронтенда. Эта группа по умолчанию устанавливается для каждого создаваемого материала. По умолчанию это Public.
**Группа для приватного доступа** — это группа, на которую будет заменены права, по умолчанию Registered. Можете создать другую группу, например "Рекламодатели", и зарегистрированным пользователям эти материалы также не будут видны.

## Использование
Вам нужно самостоятельно добавить пользовательские поля для материалов advertising (рекламный материал) и hiding (дата скрытия). Поле advertising должно иметь значения 1 или 0 (является материал рекламным или нет). По наличию этого поля определяется, будет ли материал обрабатываться плагином. Поле hiding должно содержать дату, после которой материал скрывается. Лучше добавить группу полей "Реклама", и туда поместить эти два поля. 

После того, как поля добавлены, нужно зайти в матералы и в настройках выставить нужные значения. После сохранения материала он будет обработан плагином в порядке очереди.

Установите плагин. Задайте ему настройки, соответствующие вашим потребностям. После активации плагин начнет работу. 

## Как быть со старыми материалами
Если на сайте имеется много материалов, которые публиковались задолго до принятия поправок в закон 38-ФЗ, то можно либо вручную задать им значения пользовательских полей, либо запросом в базу данных. Запрос может быть таким:

```sql
-- Укажите нужный ID категории и дату публикации
SET @catid = 36;  -- ID категории, в которой нужно искать рекламные материалы
SET @date = '2024-12-31';  -- Дата, после которой материалы скрываются

-- Вставка новых записей в #__fields_values (поправьте префикс таблиц на свой)
INSERT INTO `youprefix_fields_values` (item_id, field_id, value)
SELECT c.id, 1, '1' 
FROM `youprefix_content` c
LEFT JOIN `youprefix_fields_values` fv ON c.id = fv.item_id
WHERE c.catid = @catid
  AND c.publish_up < @date
  AND c.state = 1
  AND c.access = 1
  AND fv.item_id IS NULL

UNION ALL

SELECT c.id, 5, '2025-05-04 16:05:05'
FROM `youprefix_content` c
LEFT JOIN `youprefix_fields_values` fv ON c.id = fv.item_id
WHERE c.catid = @catid
  AND c.publish_up < @date
  AND c.state = 1
  AND c.access = 1
  AND fv.item_id IS NULL;
```
